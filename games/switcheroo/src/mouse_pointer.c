#include <stdint.h>
#include "f256lib.h"
#include "mouse_pointer.h"


uint8_t busy_mouse[16][16] = {
    {0x0,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x0,0x0},
    {0x0,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x0,0x0},
    {0x0,0x0,0x1,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x1,0x0,0x0,0x0},
    {0x0,0x0,0x1,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x1,0x0,0x0,0x0},
    {0x0,0x0,0x1,0xff,0xff,0x6e,0x6e,0x6e,0x6e,0x6e,0xff,0xff,0x1,0x0,0x0,0x0},
    {0x0,0x0,0x0,0x1,0xff,0xff,0x6e,0x6e,0x6e,0xff,0xff,0x1,0x0,0x0,0x0,0x0},
    {0x0,0x0,0x0,0x0,0x1,0xff,0xff,0x6e,0xff,0xff,0x1,0x0,0x0,0x0,0x0,0x0},
    {0x0,0x0,0x0,0x0,0x0,0x1,0xff,0x6e,0xff,0x1,0x0,0x0,0x0,0x0,0x0,0x0},
    {0x0,0x0,0x0,0x0,0x1,0xff,0xff,0xff,0xff,0xff,0x1,0x0,0x0,0x0,0x0,0x0},
    {0x0,0x0,0x0,0x1,0xff,0xff,0xff,0x6e,0xff,0xff,0xff,0x1,0x0,0x0,0x0,0x0},
    {0x0,0x0,0x1,0xff,0xff,0xff,0x6e,0x6e,0x6e,0xff,0xff,0xff,0x1,0x0,0x0,0x0},
    {0x0,0x0,0x1,0xff,0xff,0x6e,0x6e,0x6e,0x6e,0x6e,0xff,0xff,0x1,0x0,0x0,0x0},
    {0x0,0x0,0x1,0xff,0x6e,0x6e,0x6e,0x6e,0x6e,0x6e,0x6e,0xff,0x1,0x0,0x0,0x0},
    {0x0,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x0,0x0},
    {0x0,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x0,0x0},
    {0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0}
};

uint8_t normal_mouse[16][16] = {
    {0x1,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0},
    {0x1,0x1,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0},
    {0x1,0x7b,0x1,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0},
    {0x1,0x7b,0xff,0x1,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0},
    {0x1,0x7b,0xff,0xff,0x1,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0},
    {0x1,0x7b,0xff,0xff,0xff,0x1,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0},
    {0x1,0x7b,0xff,0xff,0xff,0xff,0x1,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0},
    {0x1,0x7b,0xff,0xff,0xff,0xff,0xff,0x1,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0},
    {0x1,0x7b,0xff,0xff,0xff,0xff,0x7b,0x7b,0x1,0x0,0x0,0x0,0x0,0x0,0x0,0x0},
    {0x1,0x7b,0xff,0xff,0xff,0x7b,0x1,0x1,0x1,0x0,0x0,0x0,0x0,0x0,0x0,0x0},
    {0x1,0x7b,0xff,0x1,0x7b,0xa4,0xa4,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0},
    {0x1,0x7b,0x53,0x0,0x1,0x7b,0xa4,0x1,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0},
    {0x1,0x1,0x0,0x0,0x1,0x1,0xa4,0xa4,0x1,0x0,0x0,0x0,0x0,0x0,0x0,0x0},
    {0x0,0x0,0x0,0x0,0x0,0x1,0x7b,0xa4,0x1,0x0,0x0,0x0,0x0,0x0,0x0,0x0},
    {0x0,0x0,0x0,0x0,0x0,0x1,0x1,0x7b,0x1,0x0,0x0,0x0,0x0,0x0,0x0,0x0},
    {0x0,0x0,0x0,0x0,0x0,0x0,0x1,0x1,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0}
};

void load_mouse_cursor(uint8_t cursor[16][16]) {
    // The mouse cursor is stored in the memory-mapped I/O area starting at 0xCC00
    
    for (uint8_t y = 0; y < 16; y++) {
        for (uint8_t x = 0; x < 16; x++) {
            POKE(0xCC00 + y * 16 + x, cursor[y][x]);
        }
    }
}

void set_mouse_cursor(mouse_cursor_t cursor_type) {

    if (cursor_type == MOUSE_CURSOR_BUSY) {
        load_mouse_cursor(busy_mouse);
    } else {
        load_mouse_cursor(normal_mouse);
    }
}

void enable_mouse() {
    POKE(PS2_M_MODE_EN, 0x01);      // Enable mouse (bit0=enable, bit1=mode)

}

void disable_mouse() {
    POKE(PS2_M_MODE_EN, 0x00);      // Disable mouse
    POKEW(PS2_M_X_LO, 639);         // move it out of the way
    POKEW(PS2_M_Y_LO, 479);
}

void center_mouse() {
    POKEW(PS2_M_X_LO, 320);         // Center mouse at 320x240 (center of 640x480)
    POKEW(PS2_M_Y_LO, 240);
}

void poll_and_refresh_mouse_postion() {


    kernelNextEvent();
    if (kernelEventData.type == kernelEvent(mouse.DELTA)) {

        int8_t boost_x = 1;
        int8_t boost_y = 1;
        int8_t delta_x = (int8_t)kernelEventData.u.mouse.delta.x;
        int8_t delta_y = (int8_t)kernelEventData.u.mouse.delta.y;
        
        if (delta_x > 4 || delta_x < -4) boost_x = 2;
        if (delta_y > 4 || delta_y < -4) boost_y = 2;
        
        // Read current position from hardware
        int16_t hw_x = PEEKW(PS2_M_X_LO);
        int16_t hw_y = PEEKW(PS2_M_Y_LO);
        
        // Apply delta with boost
        int16_t new_x = hw_x + boost_x * delta_x;
        int16_t new_y = hw_y + boost_y * delta_y;
        
        // Clamp to mouse hardware bounds (640x480 regardless of video mode)
        // The mouse coordinate system is always 640x480 even in 320x240 mode
        if (new_x < 0) new_x = 0;
        if (new_x >= 640) new_x = 639;
        if (new_y < 0) new_y = 0;
        if (new_y >= 480) new_y = 479;
        
        // Write back to hardware registers
        POKEW(PS2_M_X_LO, new_x);
        POKEW(PS2_M_Y_LO, new_y);
    }
}
